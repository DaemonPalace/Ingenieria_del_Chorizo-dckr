require("dotenv").config();
const fs = require("fs");
const path = require("path");
const Minio = require("minio");

// Helper â€“ safely read a secret file (throws a clear error if missing)
function readSecret(fileEnvVar, name) {
  if (!fileEnvVar) {
    throw new Error(`Environment variable for ${name} is not defined`);
  }
  try {
    return fs.readFileSync(fileEnvVar, 'utf8').trim();
  } catch (err) {
    throw new Error(`Failed to read ${name} from ${fileEnvVar}: ${err.message}`);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MinIO client
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const minioClient = new Minio.Client({
  endPoint: process.env.MINIO_HOST || 'minio',
  port: parseInt(process.env.MINIO_PORT, 10) || 9000,
  useSSL: true,
  accessKey: readSecret(process.env.MINIO_ACCESS_KEY_FILE, 'MinIO access key'),
  secretKey: readSecret(process.env.MINIO_SECRET_KEY_FILE, 'MinIO secret key'),
});

const bucketName = "arepabuelas-products";
const IMG_DIR = path.join(__dirname, "images", "products");

console.log("ğŸš€ [UPLOAD] Subida masiva de imÃ¡genes a MinIO iniciada...");
console.log("ğŸ“ Carpeta local:", IMG_DIR);

// ===============================
// ğŸ§  FUNCIÃ“N PRINCIPAL
// ===============================
async function uploadAllImages() {
  try {
    // --- Verificar carpeta ---
    if (!fs.existsSync(IMG_DIR)) {
      throw new Error("âŒ No existe la carpeta de imÃ¡genes: " + IMG_DIR);
    }

    // --- Verificar bucket ---
    try {
      const exists = await minioClient.bucketExists(bucketName);
      if (!exists) {
        console.log(`ğŸ“¦ Bucket '${bucketName}' no existe. CreÃ¡ndolo...`);
        await minioClient.makeBucket(bucketName, "us-east-1");
        console.log("âœ… Bucket creado correctamente.");
      } else {
        console.log(`ğŸª£ Bucket '${bucketName}' ya existe, continuando...`);
      }
    } catch (err) {
      if (
        err.code === "BucketAlreadyOwnedByYou" ||
        err.code === "BucketAlreadyExists"
      ) {
        console.log(`ğŸª£ Bucket '${bucketName}' ya existe (controlado).`);
      } else {
        throw err;
      }
    }

    // --- Listar imÃ¡genes ---
    const files = fs.readdirSync(IMG_DIR);
    if (files.length === 0) {
      console.warn("âš ï¸ No se encontraron imÃ¡genes en:", IMG_DIR);
      return;
    }
    console.log("ğŸ“¸ ImÃ¡genes encontradas:", files);

    // --- Subir imÃ¡genes ---
    for (const file of files) {
      const filePath = path.join(IMG_DIR, file);
      const extension = file.split(".").pop().toLowerCase();
      const contentType =
        extension === "jpg" || extension === "jpeg"
          ? "image/jpeg"
          : extension === "png"
          ? "image/png"
          : "application/octet-stream";

      try {
        console.log(`ğŸ“¤ Subiendo '${file}'...`);
        await minioClient.fPutObject(bucketName, file, filePath, {
          "Content-Type": contentType,
        });
        console.log(
          `âœ… Imagen subida: ${process.env.MINIO_PROTOCOL}://${process.env.MINIO_PUBLIC_HOST}:${process.env.MINIO_PORT}/${bucketName}/${file}`
        );
      } catch (uploadErr) {
        console.error(`âŒ Error subiendo '${file}':`, uploadErr.message);
      }
    }

    console.log("ğŸ‰ Todas las imÃ¡genes se subieron correctamente.");
  } catch (err) {
    console.error("âŒ [UPLOAD] Error general completo:");
    console.error(err);
  }
}

// ===============================
// ğŸŸ¢ EJECUCIÃ“N
// ===============================
uploadAllImages();
